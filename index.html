<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Pasien</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Menggunakan font Inter secara global */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Gaya kustom untuk notifikasi */
        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1050; /* Pastikan di atas modal */
            min-width: 250px;
        }
        .logo{
            width: 200px;
            height: 200px;
            background-image: url("img/logo4.jpg");
            background-repeat: no-repeat;
            border-radius: 100px;
        }
        /* Gaya untuk spinner loading */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100; /* Di atas modal */
        }
        .miscellaneous-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .miscellaneous-item:last-child {
            border-bottom: none;
        }
        /* Gaya untuk elemen yang disembunyikan saat cetak PDF */
        .hide-for-pdf {
            display: none !important;
        }
    </style>
</head>
<body class="bg-light min-vh-100 d-flex align-items-start justify-content-center py-4">
    <div class="container bg-white p-4 p-md-5 rounded-3 shadow-lg" style="max-width: 1500px;">
        <center><a href="img/pebri.jpg"><div class="logo"></div></a></center>
        <h1 class="text-center mb-4 text-primary">Daftar Pasien</h1>

        <div class="mb-3 text-center">
            <small class="text-muted">ID Pengguna Lokal: <span id="user-id-display">Memuat...</span></small>
        </div>

        <div class="card text-center bg-light text-secondary shadow-sm rounded-3 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-2">Diar Hady Waluyo S.k.g</h5>
                    <p class="card-text fs-4 fw-bold" id="real-time-display">Memuat...</p>
                </div>
            </div>

        <h2 class="h4 mb-3 text-secondary bg-primary w-100 rounded-3 shadow-sm text-white text-start py-2 px-3">Tambah Pasien Baru</h2>
        <form id="form-tambah-pasien" class="row g-3 mb-4">
            <div class="col-12">
                <input type="text" style="text-transform: uppercase;" id="nama-pasien-tambah" placeholder="Nama Pasien" required
                       class="form-control rounded-3">
            </div>
            <div class="col-12">
                <input type="text" style="text-transform: uppercase;" id="alamat-pasien-tambah" placeholder="Alamat Pasien" required
                       class="form-control rounded-3">
            </div>
            <div class="col-12">
                <textarea id="keluhan-pasien-tambah" style="text-transform: uppercase;" placeholder="Keluhan Pasien" rows="3" required
                          class="form-control rounded-3"></textarea>
            </div>
            <div class="col-12">
                <textarea id="keterangan-pasien-tambah" style="text-transform: uppercase;" placeholder="Keterangan (opsional)" rows="3"
                          class="form-control rounded-3"></textarea>
            </div>
            <div class="col-12">
                <button type="submit" id="tambah-pasien-button"
                        class="btn btn-success w-100 rounded-3 shadow-sm">
                    Tambah Pasien
                </button>
            </div>
        </form>

        <h2 class="h4 mb-3 text-secondary bg-primary w-100 rounded-3 shadow-sm text-white text-start py-2 px-3">Daftar Pasien Terdaftar</h2>
        <div class="mb-4 d-flex align-items-center justify-content-between">
            <input type="text" id="cari-pasien" placeholder="Cari Pasien berdasarkan nama, alamat, atau keluhan..."
                   class="form-control rounded-3 me-2">
            <button type="button" id="cetak-pdf-button" class="btn btn-secondary rounded-3 shadow-sm me-2">
                Cetak PDF
            </button>
            <button type="button" id="hapus-semua-data-button" class="btn btn-danger rounded-3 shadow-sm">
                Hapus Semua Data
            </button>
        </div>

        <div id="report-section">
            <div class="table-responsive mb-4">
                <table class="table table-striped table-hover rounded-3 overflow-hidden shadow-sm">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th scope="col" class="py-3 px-4">No.</th>
                            <th scope="col" class="py-3 px-4">Nama</th>
                            <th scope="col" class="py-3 px-4">Alamat</th>
                            <th scope="col" class="py-3 px-4">Keluhan</th>
                            <th scope="col" class="py-3 px-4">Keterangan</th>
                            <th scope="col" class="py-3 px-4">Jenis Pembayaran</th>
                            <th scope="col" class="py-3 px-4 text-end">Bayaran (Rp)</th>
                            <th scope="col" class="py-3 px-4 text-center action-column-header">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="daftar-pasien-body">
                        </tbody>
                </table>
            </div>

            <h2 class="h4 mb-3 text-secondary bg-primary w-100 rounded-3 shadow-sm text-white text-start py-2 px-3">Pengeluaran Lain-lain</h2>
            <div class="row g-3 mb-2" id="pengeluaran-lain-lain-input-section">
                <div class="col-md-8">
                    <input type="number" id="pengeluaran-lain-input" placeholder="Jumlah Pengeluaran (Rp)" min="0"
                           class="form-control rounded-3">
                </div>
                
                <div class="col-12">
                    <textarea id="keterangan-pengeluaran-lain-input" placeholder="Keterangan Pengeluaran (opsional)" rows="2"
                              class="form-control rounded-3"></textarea>
                </div>
                <div class="col-md-4">
                    <button type="button" id="tambah-pengeluaran-lain-button"
                            class="btn btn-warning w-100 rounded-3 shadow-sm">
                        Tambahkan
                    </button>
                </div>
            </div>
            <div id="miscellaneous-expenditure-list" class="mb-4 border rounded p-3 bg-light">
                <p class="text-muted text-center mb-0" id="no-miscellaneous-data">Belum ada pengeluaran lain-lain.</p>
            </div>

            <div class="card text-center bg-success text-white shadow-sm rounded-3 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-2">Total Bayaran Semua Pasien</h5>
                    <p class="card-text fs-3 fw-bold" id="total-bayaran">Rp 0</p>
                </div>
            </div>

            <div class="card text-center bg-danger text-white shadow-sm rounded-3 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-2">Total Pengeluaran</h5>
                    <p class="card-text fs-3 fw-bold" id="total-pengeluaran">Rp 0</p>
                </div>
            </div>

            <div class="card text-center bg-primary text-white shadow-sm rounded-3">
                <div class="card-body">
                    <h5 class="card-title mb-2">Total Hasil</h5>
                    <p class="card-text fs-3 fw-bold" id="total-hasil">Rp 0</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-area" class="notification alert alert-dismissible fade show d-none" role="alert">
        <span id="notification-message"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">Konfirmasi Penghapusan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Apakah Anda yakin ingin menghapus pasien ini?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteAllConfirmModal" tabindex="-1" aria-labelledby="deleteAllConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAllConfirmModalLabel">Konfirmasi Hapus Semua Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Anda akan menghapus SEMUA data pasien dan pengeluaran yang tersimpan di komputer ini.</p>
                    <p><strong>Tindakan ini tidak dapat dibatalkan.</strong></p>
                    <p>Apakah Anda yakin ingin melanjutkan?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteAllButton">Hapus Semua</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editPasienModal" tabindex="-1" aria-labelledby="editPasienModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPasienModalLabel">Edit Detail Pasien</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-pasien">
                        <div class="mb-3">
                            <label for="nama-pasien-edit" class="form-label">Nama Pasien</label>
                            <input type="text" id="nama-pasien-edit" class="form-control rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label for="alamat-pasien-edit" class="form-label">Alamat Pasien</label>
                            <input type="text" id="alamat-pasien-edit" class="form-control rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label for="keluhan-pasien-edit" class="form-label">Keluhan Pasien</label>
                            <textarea id="keluhan-pasien-edit" rows="3" class="form-control rounded-3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="keterangan-pasien-edit" class="form-label">Keterangan</label>
                            <textarea id="keterangan-pasien-edit" rows="3" class="form-control rounded-3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="bayaran-pasien-edit" class="form-label">Bayaran (Rp)</label>
                            <input type="number" id="bayaran-pasien-edit" class="form-control rounded-3" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100 rounded-3 shadow-sm">Update Pasien</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="spinner-overlay" class="spinner-overlay d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Memuat...</span>
        </div>
    </div>

    <!-- Bootstrap JS harus dimuat SEBELUM kode kustom Anda -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script type="module">
        // Variabel global untuk data pasien dan pengeluaran di memori
        let pasienList = [];
        let miscellaneousExpenditures = [];
        let userId; // Deklarasi userId tanpa inisialisasi awal

        // Menampilkan notifikasi di pojok kanan bawah layar menggunakan Bootstrap Alert.
        window.showNotification = function(message, type = 'success') {
            const notificationArea = document.getElementById('notification-area');
            const notificationMessage = document.getElementById('notification-message');
            notificationMessage.textContent = message;
            notificationArea.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning', 'alert-info');
            notificationArea.classList.add(`alert-${type}`);
            notificationArea.classList.add('show');

            // Sembunyikan notifikasi setelah 3 detik
            setTimeout(() => {
                notificationArea.classList.remove('show');
                notificationArea.classList.add('d-none');
            }, 3000);
        };

        // Fungsi pembantu untuk memperbarui data pasien secara inline di tabel.
        window.updateInlinePatient = function(element, field, id) {
            const pasienIndex = pasienList.findIndex(p => p.id === id);
            if (pasienIndex !== -1) {
                pasienList[pasienIndex][field] = element.value;
                saveDataToLocalStorage();
                window.showNotification('Data pasien berhasil diperbarui!', 'success');
                renderPasien(); // Render ulang untuk memperbarui total
            } else {
                window.showNotification('Gagal memperbarui data pasien. Pasien tidak ditemukan.', 'danger');
            }
        };

        // Fungsi-fungsi perhitungan total
        window.calculateAndRenderTotalPengeluaran = function() {
            const totalMiscellaneous = miscellaneousExpenditures.reduce((sum, item) => sum + item.amount, 0);
            document.getElementById('total-pengeluaran').textContent = `Rp ${totalMiscellaneous.toLocaleString('id-ID')}`;
            window.calculateAndRenderTotalHasil();
        };

        window.calculateAndRenderTotalBayaran = function() {
            const total = pasienList.reduce((sum, pasien) => sum + pasien.bayaran, 0);
            document.getElementById('total-bayaran').textContent = `Rp ${total.toLocaleString('id-ID')}`;
            window.calculateAndRenderTotalHasil();
        };

        window.calculateAndRenderTotalHasil = function() {
            const totalBayaran = pasienList.reduce((sum, pasien) => sum + pasien.bayaran, 0);
            const totalPengeluaran = miscellaneousExpenditures.reduce((sum, item) => sum + item.amount, 0);
            const totalHasil = totalBayaran - totalPengeluaran;
            document.getElementById('total-hasil').textContent = `Rp ${totalHasil.toLocaleString('id-ID')}`;
        };

        /**
         * Menyimpan data pasien dan pengeluaran ke localStorage.
         */
        function saveDataToLocalStorage() {
            localStorage.setItem(`pasienList_${userId}`, JSON.stringify(pasienList));
            localStorage.setItem(`miscellaneousExpenditures_${userId}`, JSON.stringify(miscellaneousExpenditures));
        }

        /**
         * Memuat data pasien dan pengeluaran dari localStorage.
         */
        function loadDataFromLocalStorage() {
            const storedPasien = localStorage.getItem(`pasienList_${userId}`);
            const storedMisc = localStorage.getItem(`miscellaneousExpenditures_${userId}`);
            pasienList = storedPasien ? JSON.parse(storedPasien) : [];
            miscellaneousExpenditures = storedMisc ? JSON.parse(storedMisc) : [];
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const spinnerOverlay = document.getElementById('spinner-overlay');
            spinnerOverlay.classList.remove('d-none'); // Tampilkan spinner saat memuat

            // Inisialisasi userId agar persisten
            let storedUserId = localStorage.getItem('localUserId');
            if (storedUserId) {
                userId = storedUserId;
            } else {
                userId = crypto.randomUUID();
                localStorage.setItem('localUserId', userId);
            }
            document.getElementById('user-id-display').textContent = userId;

            // Mendapatkan elemen-elemen DOM untuk form tambah pasien
            const formTambahPasien = document.getElementById('form-tambah-pasien');
            const namaPasienTambahInput = document.getElementById('nama-pasien-tambah');
            const alamatPasienTambahInput = document.getElementById('alamat-pasien-tambah');
            const keluhanPasienTambahInput = document.getElementById('keluhan-pasien-tambah');
            const keteranganPasienTambahInput = document.getElementById('keterangan-pasien-tambah');
            const daftarPasienBody = document.getElementById('daftar-pasien-body');
            const cariPasienInput = document.getElementById('cari-pasien');
            const cetakPdfButton = document.getElementById('cetak-pdf-button');
            const realTimeDisplay = document.getElementById('real-time-display');
            const hapusSemuaDataButton = document.getElementById('hapus-semua-data-button'); // Tombol baru

            // Elemen DOM untuk pengeluaran lain-lain
            const pengeluaranLainInput = document.getElementById('pengeluaran-lain-input');
            const keteranganPengeluaranLainInput = document.getElementById('keterangan-pengeluaran-lain-input');
            const tambahPengeluaranLainButton = document.getElementById('tambah-pengeluaran-lain-button');
            const miscellaneousExpenditureList = document.getElementById('miscellaneous-expenditure-list');
            const noMiscellaneousData = document.getElementById('no-miscellaneous-data');

            // Elemen modal konfirmasi hapus item tunggal
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            let deleteItemId = null; // Menggunakan ID untuk penghapusan
            let deleteType = null;

            // Elemen modal konfirmasi hapus semua data
            const deleteAllConfirmModal = new bootstrap.Modal(document.getElementById('deleteAllConfirmModal'));
            const confirmDeleteAllButton = document.getElementById('confirmDeleteAllButton');

            // Elemen modal edit pasien
            const editPasienModal = new bootstrap.Modal(document.getElementById('editPasienModal'));
            const formEditPasien = document.getElementById('form-edit-pasien');
            const namaPasienEditInput = document.getElementById('nama-pasien-edit');
            const alamatPasienEditInput = document.getElementById('alamat-pasien-edit');
            const keluhanPasienEditInput = document.getElementById('keluhan-pasien-edit');
            const keteranganPasienEditInput = document.getElementById('keterangan-pasien-edit');
            const bayaranPasienEditInput = document.getElementById('bayaran-pasien-edit');
            let editingItemId = null; // Menggunakan ID untuk pengeditan

            // Elemen yang akan dicetak ke PDF
            const reportSection = document.getElementById('report-section');


            loadDataFromLocalStorage(); // Muat data saat DOM siap
            renderPasien(); // Render pasien setelah memuat data
            renderMiscellaneousExpenditures(); // Render pengeluaran setelah memuat data
            window.calculateAndRenderTotalPengeluaran();
            window.calculateAndRenderTotalBayaran();
            window.calculateAndRenderTotalHasil();

            spinnerOverlay.classList.add('d-none'); // Sembunyikan spinner setelah memuat data

            /**
             * Memperbarui tampilan waktu dan tanggal saat ini.
             */
            function updateRealTimeDisplay() {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                realTimeDisplay.textContent = now.toLocaleDateString('id-ID', options);
            }

            // Panggil fungsi updateRealTimeDisplay setiap detik
            setInterval(updateRealTimeDisplay, 1000);
            // Panggil sekali saat inisialisasi untuk menampilkan waktu segera
            updateRealTimeDisplay();

            /**
             * Merender (menampilkan) daftar pasien ke dalam tabel.
             * Data akan difilter berdasarkan input pencarian.
             */
            function renderPasien() {
                daftarPasienBody.innerHTML = '';

                const searchTerm = cariPasienInput.value.toLowerCase();
                const filteredPasien = pasienList.filter(pasien =>
                    pasien.nama.toLowerCase().includes(searchTerm) ||
                    pasien.alamat.toLowerCase().includes(searchTerm) ||
                    pasien.keluhan.toLowerCase().includes(searchTerm) ||
                    pasien.keterangan.toLowerCase().includes(searchTerm) ||
                    (pasien.jenisPembayaran && pasien.jenisPembayaran.toLowerCase().includes(searchTerm))
                );

                if (filteredPasien.length === 0) {
                    const noDataRow = daftarPasienBody.insertRow();
                    noDataRow.innerHTML = `<td colspan="8" class="text-center text-muted py-3">Tidak ada pasien yang ditemukan.</td>`;
                    return;
                }

                filteredPasien.forEach((pasien, idx) => {
                    const row = daftarPasienBody.insertRow();
                    row.innerHTML = `
                        <td class="py-2 px-4">${idx + 1}.</td>
                        <td class="py-2 px-4">${pasien.nama}</td>
                        <td class="py-2 px-4">${pasien.alamat}</td>
                        <td class="py-2 px-4">${pasien.keluhan}</td>
                        <td class="py-2 px-4">${pasien.keterangan}</td>
                        <td class="py-2 px-4">
                            <select class="form-select form-select-sm rounded-3" onchange="window.updateInlinePatient(this, 'jenisPembayaran', '${pasien.id}')">
                                <option value="Tunai" ${pasien.jenisPembayaran === 'Tunai' ? 'selected' : ''}>Tunai</option>
                                <option value="Transfer" ${pasien.jenisPembayaran === 'Transfer' ? 'selected' : ''}>Transfer</option>
                            </select>
                        </td>
                        <td class="py-2 px-4 text-end">${pasien.bayaran.toLocaleString('id-ID')}</td>
                        <td class="py-2 px-4 text-center action-column-cell">
                            <button class="btn btn-warning btn-sm me-2 edit-btn" data-item-id="${pasien.id}">Edit</button>
                            
                        </td>
                    `;
                });

                window.calculateAndRenderTotalPengeluaran();
                window.calculateAndRenderTotalBayaran();
                window.calculateAndRenderTotalHasil();
            }

            /**
             * Merender daftar pengeluaran lain-lain.
             */
            function renderMiscellaneousExpenditures() {
                miscellaneousExpenditureList.innerHTML = '';

                if (miscellaneousExpenditures.length === 0) {
                    noMiscellaneousData.classList.remove('d-none');
                } else {
                    noMiscellaneousData.classList.add('d-none');
                    miscellaneousExpenditures.forEach((item) => {
                        const div = document.createElement('div');
                        div.classList.add('miscellaneous-item');
                        div.innerHTML = `
                            <div>
                                <strong>Rp ${item.amount.toLocaleString('id-ID')}</strong>
                                <p class="text-muted mb-0">${item.description || '(Tanpa Keterangan)'}</p>
                            </div>
                            <button class="btn btn-sm btn-outline-danger delete-misc-btn hide-for-pdf-misc" data-item-id="${item.id}" data-type="misc">Hapus</button>
                        `;
                        miscellaneousExpenditureList.appendChild(div);
                    });
                }
            }

            /**
             * Menangani pengiriman formulir tambah pasien baru.
             */
            formTambahPasien.addEventListener('submit', (e) => {
                e.preventDefault();
                spinnerOverlay.classList.remove('d-none');

                const nama = namaPasienTambahInput.value.trim();
                const alamat = alamatPasienTambahInput.value.trim();
                const keluhan = keluhanPasienTambahInput.value.trim();
                const keterangan = keteranganPasienTambahInput.value.trim();
                const jenisPembayaran = 'Tunai'; // Default ke Tunai

                if (!nama || !alamat || !keluhan) {
                    window.showNotification('Harap isi semua kolom Nama, Alamat, dan Keluhan dengan benar!', 'danger');
                    spinnerOverlay.classList.add('d-none');
                    return;
                }

                const newPasien = {
                    id: crypto.randomUUID(), // ID unik untuk setiap pasien
                    nama,
                    alamat,
                    keluhan,
                    keterangan,
                    jenisPembayaran,
                    bayaran: 0,
                    createdAt: new Date().toISOString() // Simpan sebagai string ISO
                };
                pasienList.push(newPasien);
                saveDataToLocalStorage();
                renderPasien();
                window.showNotification('Pasien berhasil ditambahkan!', 'success');
                formTambahPasien.reset();
                spinnerOverlay.classList.add('d-none');
            });

            /**
             * Menangani pengiriman formulir edit pasien di dalam modal.
             */
            formEditPasien.addEventListener('submit', (e) => {
                e.preventDefault();
                spinnerOverlay.classList.remove('d-none');

                const nama = namaPasienEditInput.value.trim();
                const alamat = alamatPasienEditInput.value.trim();
                const keluhan = keluhanPasienEditInput.value.trim();
                const keterangan = keteranganPasienEditInput.value.trim();
                const bayaran = parseFloat(bayaranPasienEditInput.value);

                if (!nama || !alamat || !keluhan || isNaN(bayaran) || bayaran < 0) {
                    window.showNotification('Harap isi semua kolom dengan benar dan angka tidak boleh negatif!', 'danger');
                    spinnerOverlay.classList.add('d-none');
                    return;
                }

                const pasienIndex = pasienList.findIndex(p => p.id === editingItemId);
                if (pasienIndex !== -1) {
                    pasienList[pasienIndex] = {
                        ...pasienList[pasienIndex], // Pertahankan properti lain
                        nama,
                        alamat,
                        keluhan,
                        keterangan,
                        bayaran
                    };
                    saveDataToLocalStorage();
                    renderPasien();
                    window.showNotification('Data pasien berhasil diperbarui!', 'success');
                    editPasienModal.hide();
                } else {
                    window.showNotification('Gagal memperbarui data pasien. Pasien tidak ditemukan.', 'danger');
                }
                spinnerOverlay.classList.add('d-none');
            });

            /**
             * Menangani klik pada tombol "Tambahkan Pengeluaran Lain-lain".
             */
            tambahPengeluaranLainButton.addEventListener('click', () => {
                spinnerOverlay.classList.remove('d-none');
                const amount = parseFloat(pengeluaranLainInput.value);
                const description = keteranganPengeluaranLainInput.value.trim();

                if (!isNaN(amount) && amount >= 0) {
                    const newMisc = {
                        id: crypto.randomUUID(), // ID unik untuk setiap pengeluaran
                        amount,
                        description,
                        createdAt: new Date().toISOString()
                    };
                    miscellaneousExpenditures.push(newMisc);
                    saveDataToLocalStorage();
                    renderMiscellaneousExpenditures();
                    window.calculateAndRenderTotalPengeluaran();
                    window.showNotification(`Rp ${amount.toLocaleString('id-ID')} ditambahkan ke pengeluaran lain-lain.`, 'success');
                    pengeluaranLainInput.value = '';
                    keteranganPengeluaranLainInput.value = '';
                } else {
                    window.showNotification('Harap masukkan jumlah yang valid dan tidak negatif untuk pengeluaran lain-lain.', 'danger');
                }
                spinnerOverlay.classList.add('d-none');
            });

            /**
             * Menangani klik pada tombol hapus di daftar pengeluaran lain-lain atau pasien.
             */
            confirmDeleteButton.addEventListener('click', () => {
                spinnerOverlay.classList.remove('d-none');
                if (deleteItemId) {
                    if (deleteType === 'pasien') {
                        pasienList = pasienList.filter(p => p.id !== deleteItemId);
                        window.showNotification('Pasien berhasil dihapus!', 'success');
                    } else if (deleteType === 'misc') {
                        miscellaneousExpenditures = miscellaneousExpenditures.filter(m => m.id !== deleteItemId);
                        window.showNotification('Pengeluaran lain-lain berhasil dihapus!', 'success');
                    }
                    saveDataToLocalStorage();
                    renderPasien(); // Render ulang pasien (jika pasien dihapus)
                    renderMiscellaneousExpenditures(); // Render ulang pengeluaran (jika pengeluaran dihapus)
                    window.calculateAndRenderTotalPengeluaran(); // Hitung ulang total
                } else {
                    window.showNotification('Gagal menghapus item. ID tidak valid.', 'danger');
                }
                deleteConfirmModal.hide();
                deleteItemId = null;
                deleteType = null;
                spinnerOverlay.classList.add('d-none');
            });

            /**
             * Menangani klik pada tombol "Hapus Semua Data".
             */
            hapusSemuaDataButton.addEventListener('click', () => {
                deleteAllConfirmModal.show(); // Tampilkan modal konfirmasi
            });

            /**
             * Menangani konfirmasi penghapusan semua data.
             */
            confirmDeleteAllButton.addEventListener('click', () => {
                spinnerOverlay.classList.remove('d-none');
                pasienList = []; // Kosongkan array pasien
                miscellaneousExpenditures = []; // Kosongkan array pengeluaran
                saveDataToLocalStorage(); // Simpan perubahan ke localStorage
                renderPasien(); // Render ulang untuk menampilkan tabel kosong
                renderMiscellaneousExpenditures(); // Render ulang untuk menampilkan daftar pengeluaran kosong
                window.calculateAndRenderTotalPengeluaran(); // Perbarui total
                window.calculateAndRenderTotalBayaran(); // Perbarui total
                window.calculateAndRenderTotalHasil(); // Perbarui total
                window.showNotification('Semua data berhasil dihapus!', 'success');
                deleteAllConfirmModal.hide();
                spinnerOverlay.classList.add('d-none');
            });


            // Menangani klik pada tombol Edit atau Hapus di tabel.
            daftarPasienBody.addEventListener('click', (e) => {
                const target = e.target;
                const itemId = target.dataset.itemId; // Dapatkan item ID

                if (target.classList.contains('delete-btn')) {
                    deleteItemId = itemId;
                    deleteType = 'pasien';
                    document.getElementById('deleteConfirmModalLabel').textContent = 'Konfirmasi Penghapusan Pasien';
                    document.querySelector('#deleteConfirmModal .modal-body').textContent = 'Apakah Anda yakin ingin menghapus pasien ini?';
                    deleteConfirmModal.show();
                } else if (target.classList.contains('edit-btn')) {
                    const pasienToEdit = pasienList.find(p => p.id === itemId);
                    if (pasienToEdit) {
                        namaPasienEditInput.value = pasienToEdit.nama;
                        alamatPasienEditInput.value = pasienToEdit.alamat;
                        keluhanPasienEditInput.value = pasienToEdit.keluhan;
                        keteranganPasienEditInput.value = pasienToEdit.keterangan;
                        bayaranPasienEditInput.value = pasienToEdit.bayaran;
                        editingItemId = itemId; // Atur item ID untuk pengeditan
                        editPasienModal.show();
                    }
                }
            });

            // Menangani klik pada tombol hapus di daftar pengeluaran lain-lain.
            miscellaneousExpenditureList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-misc-btn')) {
                    deleteItemId = e.target.dataset.itemId;
                    deleteType = 'misc';
                    document.getElementById('deleteConfirmModalLabel').textContent = 'Konfirmasi Penghapusan Pengeluaran Lain-lain';
                    document.querySelector('#deleteConfirmModal .modal-body').textContent = 'Apakah Anda yakin ingin menghapus pengeluaran lain-lain ini?';
                    deleteConfirmModal.show();
                }
            });


            /**
             * Menangani klik pada tombol "Cetak PDF".
             */
            cetakPdfButton.addEventListener('click', async () => {
                spinnerOverlay.classList.remove('d-none');
                window.showNotification('Mempersiapkan PDF...', 'info');

                try {
                    // Kloning seluruh bagian laporan untuk dimanipulasi tanpa memengaruhi DOM langsung
                    const clonedReportSection = reportSection.cloneNode(true);

                    // Hapus header kolom 'Aksi' dari tabel yang dikloning
                    const clonedTableHeader = clonedReportSection.querySelector('thead tr');
                    if (clonedTableHeader) {
                        const actionHeader = clonedTableHeader.querySelector('.action-column-header');
                        if (actionHeader) {
                            actionHeader.remove();
                        }
                    }

                    // Hapus sel 'Aksi' dari setiap baris di badan tabel yang dikloning
                    const clonedTableBodyRows = clonedReportSection.querySelectorAll('tbody tr');
                    clonedTableBodyRows.forEach(row => {
                        const actionCell = row.querySelector('.action-column-cell');
                        if (actionCell) {
                            actionCell.remove();
                        }
                        // Hapus elemen select dari kolom Jenis Pembayaran
                        const selectElement = row.querySelector('select');
                        if (selectElement) {
                            const textNode = document.createTextNode(selectElement.value);
                            selectElement.parentNode.replaceChild(textNode, selectElement);
                        }
                    });


                    // Hapus tombol 'Hapus' dari daftar pengeluaran lain-lain
                    const miscDeleteButtons = clonedReportSection.querySelectorAll('.hide-for-pdf-misc');
                    miscDeleteButtons.forEach(button => {
                        button.remove();
                    });

                    // Hapus bagian input pengeluaran lain-lain
                    const clonedPengeluaranInputSection = clonedReportSection.querySelector('#pengeluaran-lain-lain-input-section');
                    if (clonedPengeluaranInputSection) {
                        clonedPengeluaranInputSection.remove();
                    }

                    // Hapus bagian tampilan real-time dari kloningan
                    const clonedRealTimeDisplayCard = clonedReportSection.querySelector('.card.text-center.bg-light.text-secondary.shadow-sm.rounded-3.mb-3');
                    if (clonedRealTimeDisplayCard) {
                        clonedRealTimeDisplayCard.remove();
                    }


                    // Tambahkan sementara bagian yang dikloning ke body untuk dirender oleh html2canvas
                    clonedReportSection.style.position = 'absolute';
                    clonedReportSection.style.left = '-9999px';
                    document.body.appendChild(clonedReportSection);

                    const canvas = await html2canvas(clonedReportSection, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');

                    // Hapus bagian yang dikloning dari body setelah render
                    document.body.removeChild(clonedReportSection);

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 200;
                    const pageHeight = pdf.internal.pageSize.height;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 5, position + 5, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 5, position + 5, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save('daftar-pasien.pdf');
                    window.showNotification('PDF berhasil dibuat dan diunduh!', 'success');
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    window.showNotification('Gagal membuat PDF. Coba lagi.', 'danger');
                } finally {
                    spinnerOverlay.classList.add('d-none');
                }
            });

            // Menangani klik pada tombol pencarian.
            cariPasienInput.addEventListener('keyup', renderPasien);
        });
    </script>
</body>
</html>
